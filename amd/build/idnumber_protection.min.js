define("quizaccess_faceid/idnumber_protection",["jquery","core/ajax","core/notification","core/modal_factory","core/modal_events"],(function($,Ajax,Notification,ModalFactory,ModalEvents){var module={init:function(wwwroot){var idnumberField=$("#id_idnumber");if(0!==idnumberField.length){var originalValue=idnumberField.val(),fieldUnlocked=!1;idnumberField.prop("readonly",!0),idnumberField.css({"background-color":"#f0f0f0",cursor:"not-allowed"});var unlockButton=$("<button>").attr("type","button").addClass("btn btn-secondary btn-sm ml-2").text(M.util.get_string("unlock_idnumber","quizaccess_faceid")).css("margin-left","10px");idnumberField.after(unlockButton);var helpText=$("<div>").addClass("form-text text-muted small").text(M.util.get_string("idnumber_locked_help","quizaccess_faceid"));unlockButton.after(helpText),unlockButton.on("click",(function(e){e.preventDefault(),module.showPasswordDialog(wwwroot,(function(success){success&&(fieldUnlocked=!0,idnumberField.prop("readonly",!1),idnumberField.css({"background-color":"#fff",cursor:"text"}),unlockButton.hide(),helpText.text(M.util.get_string("idnumber_unlocked_help","quizaccess_faceid")),idnumberField.focus())}))})),idnumberField.closest("form").on("submit",(function(){if(!fieldUnlocked&&idnumberField.val()!==originalValue)return Notification.alert(M.util.get_string("error","core"),M.util.get_string("idnumber_unauthorized_change","quizaccess_faceid"),M.util.get_string("ok","core")),!1}))}},showPasswordDialog:function(wwwroot,callback){console.log("showPasswordDialog called"),ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.util.get_string("idnumber_password_title","quizaccess_faceid"),body:'<div class="form-group"><div id="idnumber-password-error" class="alert alert-danger" style="display:none;" role="alert"></div><label for="idnumber-password-input">'+M.util.get_string("idnumber_password_prompt","quizaccess_faceid")+'</label><input type="password" class="form-control" id="idnumber-password-input" name="idnumber-pwd-'+Date.now()+'" placeholder="'+M.util.get_string("password","core")+'" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-form-type="other"></div>'}).then((function(modal){console.log("Modal created successfully"),modal.setSaveButtonText(M.util.get_string("confirm","core")),modal.getRoot().on(ModalEvents.save,(function(e){console.log("Save button clicked"),e.preventDefault();var passwordInput=document.getElementById("idnumber-password-input"),password=passwordInput?passwordInput.value.trim():"",errorDiv=$("#idnumber-password-error");if(console.log("Password verification attempt:",{passwordLength:password.length,hasValue:!!password,inputFound:!!passwordInput,inputElement:passwordInput}),errorDiv.hide().text(""),!password)return errorDiv.text(M.util.get_string("required","core")).show(),void(passwordInput&&passwordInput.focus());errorDiv.removeClass("alert-danger").addClass("alert-info").text("Verificando...").show(),module.verifyPassword(wwwroot,password,(function(success,message){success?(modal.hide(),modal.destroy(),Notification.addNotification({message:message,type:"success"}),callback(!0)):(errorDiv.removeClass("alert-info").addClass("alert-danger").text(message).show(),passwordInput&&(passwordInput.value="",passwordInput.focus()))}))})),modal.getRoot().on(ModalEvents.cancel,(function(){console.log("Modal cancelled, destroying..."),modal.destroy(),callback(!1)})),modal.getRoot().on(ModalEvents.hidden,(function(){console.log("Modal hidden, destroying..."),modal.destroy()})),modal.show(),setTimeout((function(){var input=document.getElementById("idnumber-password-input");input&&input.focus()}),500)}))},verifyPassword:function(wwwroot,password,callback){$.ajax({url:wwwroot+"/mod/quiz/accessrule/faceid/verify_idnumber_password.php",method:"POST",data:{password:password,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){callback(response.success,response.message)},error:function(xhr,status,error){console.error("ID Number Password Verification Error:"),console.error("Status:",status),console.error("Error:",error),console.error("Response Status:",xhr.status),console.error("Response Text:",xhr.responseText);var errorMessage=M.util.get_string("error","core");403===xhr.status?errorMessage="Error de sesi칩n. Por favor recargue la p치gina.":404===xhr.status?errorMessage="Error: Archivo de verificaci칩n no encontrado.":500===xhr.status?errorMessage="Error del servidor. Por favor contacte al administrador.":xhr.responseText&&(errorMessage="Error: "+status+" - Ver consola para m치s detalles"),callback(!1,errorMessage)}})}};return module}));

//# sourceMappingURL=idnumber_protection.min.js.map